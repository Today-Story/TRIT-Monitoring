groups:
- name: system-health-rules
  rules:
  # 1. Ïù∏Ïä§ÌÑ¥Ïä§ Îã§Ïö¥
  - alert: InstanceDown
    expr: up == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "‚ùå {{ $labels.instance }} DOWN"
      description: "{{ $labels.instance }} of job {{ $labels.job }} is unreachable for more than 2 minutes."

  # 2. Node Exporter - CPU ÏÇ¨Ïö©Î•† 80% Ïù¥ÏÉÅ
  - alert: HighCPUUsage
    expr: |
      100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[2m])) * 100) > 80
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "‚ö†Ô∏è High CPU usage on {{ $labels.instance }}"
      description: "CPU usage is above 80% for more than 2 minutes. Current value: {{ $value | printf \"%.2f\" }}%"

  # 3. Node Exporter - Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Î•† 80% Ïù¥ÏÉÅ
  - alert: HighMemoryUsage
    expr: |
      (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "‚ö†Ô∏è High memory usage on {{ $labels.instance }}"
      description: "Memory usage is above 80%. Current value: {{ $value | printf \"%.2f\" }}%"

  # 4. Node Exporter - ÎîîÏä§ÌÅ¨ ÏÇ¨Ïö©Î•† 90% Ïù¥ÏÉÅ
  - alert: HighDiskUsage
    expr: |
      (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 90
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "üíæ High disk usage on {{ $labels.instance }}"
      description: "Disk usage is above 90%. Current value: {{ $value | printf \"%.2f\" }}%"

  # 5. cAdvisor - Ïª®ÌÖåÏù¥ÎÑà CPU ÏÇ¨Ïö©Î•† 80% Ïù¥ÏÉÅ
  - alert: HighContainerCPU
    expr: rate(container_cpu_usage_seconds_total[1m]) * 100 > 80
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "‚ö†Ô∏è High container CPU usage on {{ $labels.instance }}"
      description: "Container CPU usage is above 80%. Current: {{ $value | printf \"%.2f\" }}%"

  # 6. cAdvisor - Ïª®ÌÖåÏù¥ÎÑà Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ 90% Ïù¥ÏÉÅ
  - alert: HighContainerMemory
    expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 90
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "üö® High container memory usage on {{ $labels.instance }}"
      description: "Container memory usage is above 90%. Current: {{ $value | printf \"%.2f\" }}%"

- name: application-alerts
  rules:
  # 7. Spring Boot - ÏöîÏ≤≠ ÏßÄÏó∞ ÏãúÍ∞Ñ (avg > 1.5s)
  - alert: HighRequestLatency
    expr: rate(http_server_requests_seconds_sum[1m]) / rate(http_server_requests_seconds_count[1m]) > 1.5
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "üê¢ High average request latency on {{ $labels.instance }}"
      description: "Average request latency is above 1.5s. Current: {{ $value | printf \"%.2f\" }}s"

  # 8. Spring Boot - ÏóêÎü¨Ïú® (5xx ÎπÑÏú®)
  - alert: HighErrorRate
    expr: |
      rate(http_server_requests_seconds_count{status=~"5.."}[1m]) 
      / rate(http_server_requests_seconds_count[1m]) > 0.2
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "üî• High 5xx error rate on {{ $labels.instance }}"
      description: "More than 20% of HTTP responses are 5xx errors. Current: {{ $value | printf \"%.2f\" }}"

- name: prometheus-health
  rules:
  # 9. Prometheus - Scrape Ïã§Ìå®
  - alert: PrometheusScrapeFailed
    expr: scrape_duration_seconds > 5
    for: 30s
    labels:
      severity: warning
    annotations:
      summary: "‚ùó Scrape duration too long on {{ $labels.instance }}"
      description: "Prometheus is taking more than 5 seconds to scrape metrics. Current: {{ $value }}s"

  # 10. Prometheus - Target ÏàòÏßë Ïã§Ìå®Ïú®
  - alert: TargetScrapeError
    expr: increase(prometheus_target_scrapes_sample_exemplar_errors_total[1m]) > 0
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "‚ö†Ô∏è Prometheus scrape error on {{ $labels.instance }}"
      description: "Prometheus scrape error occurred in last 1m"
