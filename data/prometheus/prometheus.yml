global:
  scrape_interval: 15s
  scrape_timeout: 15s
  evaluation_interval: 2m

  external_labels:
    monitor: 'codelab-monitor'

  query_log_file: query_log_file.log

rule_files:
- "rule.yml"

scrape_configs:
# 🔹 Spring Boot 애플리케이션 - backend 1 & 2
- job_name: 'backend'
  static_configs:
  - targets:
    - dev.trit.app:80
  relabel_configs:
  - source_labels: [ __metrics_path__ ]
    regex: .*
    target_label: __metrics_path__
    replacement: /backend1/actuator/prometheus
  - source_labels: [ __address__ ]
    regex: dev\.trit\.app:80
    target_label: instance
    replacement: backend-qa-backend-1

  - source_labels: [ __metrics_path__ ]
    regex: .*
    target_label: __metrics_path__
    replacement: /backend2/actuator/prometheus
  - source_labels: [ __address__ ]
    regex: dev\.trit\.app:80
    target_label: instance
    replacement: backend-qa-backend-2

# 🔹 Node Exporter - 호스트 메트릭
- job_name: 'monitoring-host'
  static_configs:
  - targets:
    - node-exporter:9100
    - ip-172-31-43-29.ap-northeast-2.compute.internal:9111
  relabel_configs:
  - source_labels: [ __address__ ]
    regex: node-exporter:9100
    target_label: instance
    replacement: monitoring
  - source_labels: [ __address__ ]
    regex: ip-172-31-43-29.*:9111
    target_label: instance
    replacement: backend-qa-host

# 🔹 cAdvisor - Docker 컨테이너 메트릭
- job_name: 'monitoring-container'
  static_configs:
  - targets:
    - cadvisor:8080
    - ip-172-31-43-29.ap-northeast-2.compute.internal:8085
  relabel_configs:
  - source_labels: [ __address__ ]
    regex: cadvisor:8080
    target_label: instance
    replacement: monitoring
  - source_labels: [ __address__ ]
    regex: ip-172-31-43-29.*:8085
    target_label: instance
    replacement: backend-qa-docker
